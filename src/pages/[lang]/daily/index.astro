---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import DailyCard from '../../../components/DailyCard.astro';
import { getCollection } from 'astro:content';
import { sortByDateDesc } from '../../../lib/content';
import { getLatestDaily } from '../../../lib/daily';

export async function getStaticPaths() {
  return [{ params: { lang: 'hi' } }, { params: { lang: 'te' } }];
}

const { lang } = Astro.params;
const entries = await getCollection('daily');
const { entry: latest, note } = getLatestDaily(entries, lang);
const archiveEntries = sortByDateDesc(
  entries.filter((entry) => entry.data.lang === lang)
);
const archiveFallback = sortByDateDesc(
  entries.filter((entry) => entry.data.lang === 'en')
);
const archive = archiveEntries.length ? archiveEntries : archiveFallback;
const latestContent = latest ? await latest.render() : null;
const pathFor = (entry) => entry.data.paths?.[lang] || entry.data.paths?.en;
---

<BaseLayout title="Daily" description="Three things: a sloka, a term, a question." lang={lang}>
  <section class="section">
    <h1 class="section-title">Daily</h1>
    <p class="muted">Three things: a sloka, a term, a question.</p>
  </section>

  {latest ? (
    <section class="section">
      {note ? <div class="notice">{note}</div> : null}
      <DailyCard>
        {latestContent ? <latestContent.Content /> : null}
      </DailyCard>
    </section>
  ) : (
    <div class="card">Daily entries are not yet available.</div>
  )}

  <section class="section">
    <h2 class="section-title">Archive</h2>
    <div class="stack">
      {archive.map((entry) => (
        <div class="card">
          <div class="eyebrow">{entry.data.date}</div>
          <div>{entry.data.sloka_ref} â€¢ {entry.data.term}</div>
          <a class="button" href={pathFor(entry)}>View</a>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
