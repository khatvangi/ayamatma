---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import AudioPlayer from '../../../components/AudioPlayer.astro';
import { getCollection } from 'astro:content';
import { getPathForLocale, getSlugFromPath } from '../../../lib/content';

export async function getStaticPaths() {
  const entries = await getCollection('listen');
  return entries.flatMap((entry) => [
    { params: { lang: 'hi', slug: getSlugFromPath(entry.data.paths.hi) } },
    { params: { lang: 'te', slug: getSlugFromPath(entry.data.paths.te) } },
  ]);
}

const { slug, lang } = Astro.params;
const entries = await getCollection('listen');
const entry = entries.find(
  (item) => getSlugFromPath(getPathForLocale(item.data.paths, lang)) === slug
);
if (!entry) {
  return Astro.redirect(`/${lang}/listen`);
}
const { Content } = await entry.render();
const duration = `${entry.data.duration_seconds} seconds`;
---

<BaseLayout title={`${entry.data.title} | Ayamatma`} description={entry.data.title} lang={lang}>
  <section class="section stack">
    <h1 class="section-title">{entry.data.title}</h1>
    <div class="muted">{entry.data.date} â€¢ {duration}</div>
  </section>

  <section class="section stack">
    <AudioPlayer src={entry.data.audio_url} duration={duration} title="Listen">
      {entry.data.companion?.length ? (
        <div>
          <div class="eyebrow">Companion notes</div>
          <div class="stack" style="margin-top: 0.75rem;">
            {entry.data.companion.map((link) => (
              <a class="muted" href={link}>{link}</a>
            ))}
          </div>
        </div>
      ) : null}
    </AudioPlayer>
    <div class="prose">
      <Content />
    </div>
  </section>
</BaseLayout>
