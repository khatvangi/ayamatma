---
// enhanced ambient player - multiple soundscapes with icons
const tracks = [
  { id: 'river', icon: 'üåä', label: 'River', src: 'https://cdn.freesound.org/previews/531/531947_4921277-lq.mp3' },
  { id: 'forest', icon: 'üå≤', label: 'Forest', src: 'https://cdn.freesound.org/previews/587/587560_12911215-lq.mp3' },
  { id: 'rain', icon: 'üåßÔ∏è', label: 'Rain', src: 'https://cdn.freesound.org/previews/346/346642_4921277-lq.mp3' },
  { id: 'bowls', icon: 'üîî', label: 'Bowls', src: 'https://cdn.freesound.org/previews/746/746486_8549328-lq.mp3' },
  { id: 'fire', icon: 'üî•', label: 'Fire', src: 'https://cdn.freesound.org/previews/499/499047_4921277-lq.mp3' },
  { id: 'silence', icon: 'ü§´', label: 'Off', src: '' },
];
---

<div class="ambient-bar" id="ambient-bar">
  <div class="ambient-tracks" id="ambient-tracks">
    {tracks.map((track, i) => (
      <button
        class={`ambient-track ${track.id === 'silence' ? 'active' : ''}`}
        data-track={track.id}
        data-src={track.src}
        title={track.label}
        aria-label={`Play ${track.label}`}
      >
        <span class="track-icon">{track.icon}</span>
      </button>
    ))}
  </div>
  <div class="ambient-volume-wrap">
    <input
      type="range"
      class="ambient-volume"
      id="ambient-volume"
      min="0"
      max="100"
      value="40"
      aria-label="Volume"
    />
    <span class="volume-icon">üîä</span>
  </div>
</div>

<audio id="ambient-audio" loop preload="none"></audio>

<style>
  .ambient-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1.5rem;
    background: var(--bg-paper);
    padding: 0.75rem 1.5rem;
    border-top: 1px solid var(--border);
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
    z-index: 1000;
  }

  .ambient-tracks {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .ambient-track {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 2px solid transparent;
    background: var(--bg-section);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 200ms ease;
    padding: 0;
  }

  .ambient-track:hover {
    background: var(--accent-cool-soft);
    transform: scale(1.1);
  }

  .ambient-track.active {
    border-color: var(--accent-cool);
    background: var(--accent-cool-soft);
    transform: scale(1.15);
  }

  .track-icon {
    font-size: 1.25rem;
    line-height: 1;
  }

  .ambient-volume-wrap {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .ambient-volume {
    width: 80px;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--border);
    border-radius: 2px;
    cursor: pointer;
  }

  .ambient-volume::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--accent-cool);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 150ms ease;
  }

  .ambient-volume::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  .ambient-volume::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: var(--accent-cool);
    border-radius: 50%;
    border: none;
    cursor: pointer;
  }

  .volume-icon {
    font-size: 1rem;
    opacity: 0.6;
  }

  /* add padding to body so content doesn't hide behind bar */
  :global(body) {
    padding-bottom: 70px;
  }

  /* mobile adjustments */
  @media (max-width: 720px) {
    .ambient-bar {
      padding: 0.5rem 1rem;
      gap: 1rem;
    }

    .ambient-track {
      width: 36px;
      height: 36px;
    }

    .track-icon {
      font-size: 1.1rem;
    }

    .ambient-volume {
      width: 60px;
    }
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', function() {
    var audio = document.getElementById('ambient-audio');
    var trackButtons = document.querySelectorAll('.ambient-track');
    var volumeSlider = document.getElementById('ambient-volume');
    var currentTrack = localStorage.getItem('ambientTrack') || 'silence';
    var savedVolume = localStorage.getItem('ambientVolume') || '40';

    if (!audio) return;

    // set initial volume
    audio.volume = parseInt(savedVolume) / 100;
    volumeSlider.value = savedVolume;

    // highlight saved track
    trackButtons.forEach(function(btn) {
      if (btn.dataset.track === currentTrack) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    // auto-play saved track if not silence
    if (currentTrack !== 'silence') {
      var savedBtn = document.querySelector('[data-track="' + currentTrack + '"]');
      if (savedBtn && savedBtn.dataset.src) {
        audio.src = savedBtn.dataset.src;
        audio.play().catch(function() {
          // autoplay blocked, user needs to click
        });
      }
    }

    // track selection
    trackButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var trackId = this.dataset.track;
        var trackSrc = this.dataset.src;

        // update active state
        trackButtons.forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');

        // save preference
        localStorage.setItem('ambientTrack', trackId);

        if (trackId === 'silence' || !trackSrc) {
          // stop playback
          audio.pause();
          audio.src = '';
        } else {
          // fade out current, fade in new
          audio.volume = 0;
          audio.src = trackSrc;
          audio.play().then(function() {
            // fade in
            var targetVol = parseInt(volumeSlider.value) / 100;
            var fadeIn = setInterval(function() {
              if (audio.volume < targetVol - 0.05) {
                audio.volume += 0.05;
              } else {
                audio.volume = targetVol;
                clearInterval(fadeIn);
              }
            }, 50);
          }).catch(function(err) {
            console.error('Playback failed:', err);
          });
        }
      });
    });

    // volume control
    volumeSlider.addEventListener('input', function() {
      audio.volume = parseInt(this.value) / 100;
      localStorage.setItem('ambientVolume', this.value);
    });
  });
</script>
